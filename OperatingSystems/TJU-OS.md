> CopyRight: VenusHui
>  
> time: 2021.12.09
>
> last edit: 2021.12.09
>  
> Reference: 《Operating System Concept》、《Morden Operating Syestems》

## 第一章 导论

### 1.0 操作系统杂谈

* 分类：基于文本的`Shell`和基于图标的`GUI(Graphical User Interface)`用户图形界面。

* 多数计算机具有两种运行模式：内核态（也称为管态、核心态）和用户态（目态、常态）
  + 软件中最基础的部分就是操作系统，运行在内核态：具有对所有硬件的完全访问权，可以执行机器能够运行的任何指令。

  + 软件的其余部分通常运行在用户态下，只能够执行机器指令中的一个子集。

  + PSW：程序状态字（程序状态寄存器），其中有一个二进制位用于控制这两种模式

  + X86：Ring0 ～Ring3
    
    一般情况下可以用Ring0表示内核态，ring3表示用户态

  + ARM：7种工作模式
    
    用户模式(usr)：ARM处理器正常的程序执行状态。

    快速中断模式(fiq)：用于高速数据传输或通道处理。

    外部中断模式(irq)：用于通用的中断处理。

    管理模式(svc)：操作系统使用的保护模式。

    数据访问终止模式(abt)：当数据或指令预取终止时进入该模式，可用于虚拟存储及存储保护。

    系统模式(sys)：运行具有特权的操作系统任务。

    定义指令中止模式(und)：当未定义的指令执行时进入该模式，可用于支持硬件协处理器的软件仿真。

  + 工作模式不同，可以运行的指令集也不同

  + 软件的工作模式是根据CPU的保护机制（硬件的权限级别）而定。

  + 特权级指令

#### 不同系统的区别

* 嵌入式系统：没有内核态

* 分布式系统：与集群式相对，建立在网络之上，是若干计算机的集合。

* 嵌入式系统：

* 集群系统

* 解释系统：采用解释方式而非硬件方式区分组件

### 1.1 什么是操作系统

#### 扩展机器

***抽象**是管理复杂性的一个关键*
* 一种**自顶向下**的观点是：操作系统的一个主要任务就是隐藏硬件，呈现给程序以及程序员良好、清晰、优雅、一致的抽象。

* 例如：所有操作系统都提供使用硬盘的又一层抽象：文件（此前的一层抽象是硬盘驱动软件）

#### 资源管理者

* 一种**自底向上**的观点是：操作系统用来管理一个复杂系统的各个部分，在相互竞争的程序之间**有序**的对处理器、存储器及其他I/O接口设备的分配。

* **多路复用**资源的实现方式：
  + 时间上复用：不同的程序或用户轮流使用

  + 空间上复用：每个客户都得到资源的一部分

### 1.3 计算机硬件简介

#### 处理器

* 每个CPU都有一套可执行的专门指令集

* 通用寄存器：保存变量和临时结果

* 专用寄存器（程序员可见）
  + 程序计数器：保存了将要取出的下一条指令的内存地址（简称为：下地址）。在指令去除之后，程序计数器就被更新。

  + 堆栈指针：指向内存中当前栈的顶端。该栈包含了每个执行过程的栈帧。

  + 程序状态字寄存器（Program Status Word, PSW）

* 流水线机制：基于指令的执行过程

* 超标量CPU：有一个保持缓冲区及多个进行特定类型计算的执行单元，每当一个执行单元空闲时就检查保持缓冲区中是否还有可处理的指令

* 多线程和多核芯片
  + 多线程允许CPU保持两个不同的线程状态，并在纳秒级的时间尺度来回切换。

  + GPU(Graphic Proessing Unit)：由上万个微核组成的处理器，擅长处理大量并行的简单计算。

#### 存储器

* 分层结构：寄存器 -> 高速缓存 -> 主存 -> 磁盘

* 寄存器
  + 访问无延时

  + 典型的存储容量为：32位：32 * 32；64位：64 * 64（均小于1KB）

* 高速缓存
  + 由硬件控制

  + 主存被分割成高速缓存行(cache line)，典型大小为64KB。

  + 最常用的高速缓存行放在CPU内（AMD）或离CPU较近的高速缓存中（Intel）

### 1.4 计算机系统组织

#### 计算机系统操作

* 初始化程序/引导程序(bootstrap program)：通常位于ROM或EEOPROM(Electrical Erasable PROM, 电可擦除可编程ROM)中，称为计算机硬件中的固件，初始化计算机的所有部分，为此，引导程序必须定位操作系统内核并且将其装入内存。

* 实现输入输出的三种方式
  
  用户程序进行一个系统调用(system call) -> 内核翻译为一个对于对应设备驱动程序（设备控制器）的过程调用 -> ：

*1. 忙等待(busy waiting)*
  + CPU轮询该设备直到对应的I/O操作完成。

*2. 中断(interrupt)*
  + 启动该设备进行I/O操作，期间CPU转而执行其他进程，等I/O操作完成时，对应的设备驱动程序通过特定的总线向中断控制器发送中断请求，若中断控制器认为可以中断，则通过总线通知CPU，让CPU暂停当下执行流，转而处理中断，一旦CPU决定处理中断，通常PC和PSW就被压入当前堆栈，并且CPU切换至内核态。

  + CPU处理中断的方式：在上一步中，中断控制器将该设备的编号放在总线上，由于只有少量预先定义的中断，所以可以用存储一个个指针，分别指向应对不同中断情况的处理程序，这一指针表就称为**中断向量**，中断向量可以通过唯一的设备号来索引。

  + 精确中断和非精确中断：精确中断是指在中断被处理前CPU的执行流中的每条指令是顺序执行的，只有在当前进程中的指令执行完毕之后才处理中断；而现代CPU通常使用流水线形式，所以要在CPU转而处理中断时保存当前已经在执行（到不同阶段）的所有指令，称为非精确中断。

*3. 使用DMA(Direct Memory Access)芯片*
  + DMA芯片是一种为I/O使用的特殊的直接存储器访问芯片，通过控制内存和某些控制器中的位流，无需CPU持续干预，避免了忙等待。CPU对DMA芯片进行设置，说明需要传输的字节数、有关的设备、内存地址、传输方向等信息，然后启动DMA，在DMA芯片完成时，会触发一个中断。
  